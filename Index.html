<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nuestro Pulso - Community, News & Explore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Define custom CSS variables for color palette */
        :root {
            --primary-dark: #1f3f6c; /* Deep, professional blue */
            --primary-light: #2c5187; /* Slightly lighter shade */
            --accent-vibrant: #48d1cc; /* Cool, modern cyan */
            --background-light: #f9fafb;
            --text-color: #333;
            --subtle-gray: #e6e9ee;
            --card-bg: #ffffff;
        }

        /* Tailwind custom styles (to ensure variables are picked up) */
        .bg-primary-dark { background-color: var(--primary-dark); }
        .bg-primary-light { background-color: var(--primary-light); }
        .bg-accent-vibrant { background-color: var(--accent-vibrant); }
        .bg-background-light { background-color: var(--background-light); }
        .text-primary-dark { color: var(--primary-dark); }
        .text-primary-light { color: var(--primary-light); }
        .text-accent-vibrant { color: var(--accent-vibrant); }
        .text-text-color { color: var(--text-color); }
        .text-subtle-gray { color: var(--subtle-gray); }
        .bg-card-bg { background-color: var(--card-bg); }
        .border-primary-dark { border-color: var(--primary-dark); }
        .border-primary-light { border-color: var(--primary-light); }
        .border-accent-vibrant { border-color: var(--accent-vibrant); }
        .border-subtle-gray { border-color: var(--subtle-gray); }
        .hover\:bg-primary-dark:hover { background-color: var(--primary-dark); }
        .hover\:bg-primary-light:hover { background-color: var(--primary-light); }
        .hover\:bg-accent-vibrant:hover { background-color: var(--accent-vibrant); }
        .hover\:text-primary-dark:hover { color: var(--primary-dark); }
        .hover\:text-primary-light:hover { color: var(--primary-light); }
        .hover\:text-accent-vibrant:hover { color: var(--accent-vibrant); }

        /* Custom Fonts */
        .font-poppins {
          font-family: 'Poppins', sans-serif;
        }
        .font-montserrat {
          font-family: 'Montserrat', sans-serif;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
          width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #888;
          border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: #555;
        }
        
        /* Animations */
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes fadeInScale {
          from { opacity: 0; transform: scale(0.95); }
          to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeInUp {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-zoom-in {
          animation: fadeInScale 0.3s ease-out forwards;
        }
        .animate-fade-in-up {
          animation: fadeInUp 0.6s ease-out forwards;
        }
    </style>
</head>
<body class="font-poppins antialiased text-text-color bg-background-light">
    <p id="diagnostic-message" class="text-center text-red-500 bg-yellow-100 p-2 text-sm z-50 relative">
        Loading app... If this message persists, there's a problem with the JavaScript.
    </p>

    <div id="root"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const diagMessage = document.getElementById('diagnostic-message');
            if (diagMessage) {
                diagMessage.innerText = `JS Error: ${message} (Line: ${lineno})`;
                diagMessage.style.backgroundColor = 'red';
                diagMessage.style.color = 'white';
            }
            console.error("Global JS Error:", message, source, lineno, colno, error);
            return true;
        };

        window.onunhandledrejection = function(event) {
            const diagMessage = document.getElementById('diagnostic-message');
            if (diagMessage) {
                diagMessage.innerText = `Unhandled Promise Rejection: ${event.reason}`;
                diagMessage.style.backgroundColor = 'red';
                diagMessage.style.color = 'white';
            }
            console.error("Global Unhandled Promise Rejection:", event.reason);
        };
    </script>
    
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin onerror="document.getElementById('diagnostic-message').innerText = 'Error: Failed to load React library.'; document.getElementById('diagnostic-message').style.backgroundColor = 'red'; document.getElementById('diagnostic-message').style.color = 'white';"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin onerror="document.getElementById('diagnostic-message').innerText = 'Error: Failed to load ReactDOM library.'; document.getElementById('diagnostic-message').style.backgroundColor = 'red'; document.getElementById('diagnostic-message').style.color = 'white';"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" onerror="document.getElementById('diagnostic-message').innerText = 'Error: Failed to load Babel library.'; document.getElementById('diagnostic-message').style.backgroundColor = 'red'; document.getElementById('diagnostic-message').style.color = 'white';"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-router-dom@6.23.1/dist/index.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script type="text/babel">
        // Firebase modules are now globally available under the `firebase` object
        const { HashRouter, Routes, Route, Link, useParams } = window.ReactRouterDOM;

        const diagMessage = document.getElementById('diagnostic-message');

        // Explicitly check for global variables, providing defaults if needed for robustness
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id-fallback';
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const GEMINI_API_KEY = typeof __gemini_api_key !== 'undefined' ? __gemini_api_key : '';

        if (!firebaseConfigRaw) {
            diagMessage.innerText = 'Critical Error: Firebase config is missing. Cannot initialize Firebase.';
            diagMessage.style.backgroundColor = 'red';
            diagMessage.style.color = 'white';
            console.error("Critical Error: __firebase_config is undefined.");
        }

        let firebaseConfig;
        try {
            firebaseConfig = firebaseConfigRaw ? JSON.parse(firebaseConfigRaw) : {};
        } catch (e) {
            diagMessage.innerText = `Critical Error: Invalid Firebase config JSON. ${e.message}`;
            diagMessage.style.backgroundColor = 'red';
            diagMessage.style.color = 'white';
            console.error("Critical Error: Invalid Firebase config JSON:", e);
        }

        // --- Firebase Initialization and Context ---
        const FirebaseContext = React.createContext(null);

        const FirebaseProvider = ({ children }) => {
          const [app, setApp] = React.useState(null);
          const [db, setDb] = React.useState(null);
          const [auth, setAuth] = React.useState(null);
          const [currentUser, setCurrentUser] = React.useState(null);
          const [userId, setUserId] = React.useState(null);
          const [isAuthReady, setIsAuthReady] = React.useState(false);
          const [friends, setFriends] = React.useState([]);
          const [pendingRequests, setPendingRequests] = React.useState([]);

          React.useEffect(() => {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                setIsAuthReady(true);
                return;
            }

            let firebaseApp, firestoreDb, firebaseAuth;
            try {
                // Correctly initialize Firebase from the global `firebase` object
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firestoreDb = firebaseApp.firestore();
                firebaseAuth = firebaseApp.auth();

                setApp(firebaseApp);
                setDb(firestoreDb);
                setAuth(firebaseAuth);
            } catch (error) {
                diagMessage.innerText = `Firebase Init Error: ${error.message}`;
                diagMessage.style.backgroundColor = 'red';
                diagMessage.style.color = 'white';
                console.error("Firebase Initialization Error:", error);
                setIsAuthReady(true);
                return;
            }

            const unsubscribe = firebaseAuth.onAuthStateChanged(async (user) => {
              try {
                if (user) {
                  setCurrentUser(user);
                  setUserId(user.uid);
                } else {
                  if (initialAuthToken) {
                    await firebaseAuth.signInWithCustomToken(initialAuthToken);
                  } else {
                    const anonymousUser = await firebaseAuth.signInAnonymously();
                    setCurrentUser(anonymousUser.user);
                    setUserId(anonymousUser.user.uid);
                  }
                }
              } catch (error) {
                console.error("Error during Firebase sign-in/auth state change:", error);
                diagMessage.innerText = `Auth Error: ${error.message}`;
                diagMessage.style.backgroundColor = 'red';
                diagMessage.style.color = 'white';
                setUserId(crypto.randomUUID());
              } finally {
                setIsAuthReady(true);
              }
            });

            return () => unsubscribe();
          }, [firebaseConfigRaw, initialAuthToken]);

          React.useEffect(() => {
            if (!db || !userId || !isAuthReady || appId === 'default-app-id-fallback') return;

            try {
                // Adjusting Firestore calls to V8 syntax if needed (your existing code looks good here)
                const friendsCollectionRef = db.collection(`/artifacts/${appId}/users/${userId}/friends`);
                const unsubscribeFriends = friendsCollectionRef.onSnapshot((snapshot) => {
                  const friendsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  setFriends(friendsData.filter(f => f.status === 'accepted'));
                  setPendingRequests(friendsData.filter(f => f.status === 'pending' && f.requesterId !== userId));
                });

                return () => {
                  unsubscribeFriends();
                };
            } catch (error) {
                console.error("Error setting up friends listener:", error);
                diagMessage.innerText = `Friends Listener Error: ${error.message}`;
                diagMessage.style.backgroundColor = 'red';
                diagMessage.style.color = 'white';
            }
          }, [db, userId, isAuthReady, appId]);

          const value = { app, db, auth, currentUser, userId, isAuthReady, friends, pendingRequests, signOutUser: () => auth.signOut(), appId };

          return (
            <FirebaseContext.Provider value={value}>
              {children}
            </FirebaseContext.Provider>
          );
        };

        const useFirebase = () => React.useContext(FirebaseContext);

        // --- API Utility Functions ---
        const GEMINI_FLASH_MODEL = "gemini-2.5-flash-preview-05-20";
        const IMAGEN_MODEL = "imagen-3.0-generate-002";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";

        async function callGeminiAPI(payload, model = GEMINI_FLASH_MODEL) {
          let attempts = 0;
          const maxAttempts = 5;
          const initialDelay = 1000;

          while (attempts < maxAttempts) {
            try {
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              if (response.status === 429) {
                const delay = initialDelay * Math.pow(2, attempts);
                await new Promise(res => setTimeout(res, delay));
                attempts++;
                continue;
              }

              if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`API error: ${response.statusText} - ${JSON.stringify(errorBody)}`);
              }

              const result = await response.json();
              return result;

            } catch (error) {
              console.error(`Attempt ${attempts + 1} failed:`, error);
              const delay = initialDelay * Math.pow(2, attempts);
              await new Promise(res => setTimeout(res, delay));
              attempts++;
            }
          }
          throw new Error("Max API retry attempts reached.");
        }

        async function callImagenAPI(prompt) {
          let attempts = 0;
          const maxAttempts = 5;
          const initialDelay = 1000;

          while (attempts < maxAttempts) {
            try {
              const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } }; // Fixed payload structure
              const apiUrl = `https://us-central1-aiplatform.googleapis.com/v1/projects/YOUR_PROJECT_ID/locations/us-central1/publishers/google/models/imagen-3-0-generate-002:predict?key=${GEMINI_API_KEY}`; // Fixed URL for Imagen API
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              if (response.status === 429) {
                const delay = initialDelay * Math.pow(2, attempts);
                await new Promise(res => setTimeout(res, delay));
                attempts++;
                continue;
              }

              if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`Imagen API error: ${response.statusText} - ${JSON.stringify(errorBody)}`);
              }

              const result = await response.json();
              if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
              } else {
                throw new Error("No image data found in Imagen API response.");
              }
            } catch (error) {
              console.error(`Attempt ${attempts + 1} failed for Imagen API:`, error);
              const delay = initialDelay * Math.pow(2, attempts);
              await new Promise(res => setTimeout(res, delay));
              attempts++;
            }
          }
          throw new Error("Max Imagen API retry attempts reached.");
        }

        async function callTtsApi(text, voiceName = "Kore") {
          let attempts = 0;
          const maxAttempts = 5;
          const initialDelay = 1000;

          while (attempts < maxAttempts) {
            try {
              const payload = {
                contents: [{
                  parts: [{ text: text }]
                }],
                generationConfig: {
                  responseMimeType: "audio/wav", // Corrected MIME type
                  speechConfig: {
                    voiceConfig: {
                      prebuiltVoiceConfig: { voiceName: voiceName }
                    }
                  }
                },
                model: "tts-1-dev" // Using a known TTS model
              };
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${payload.model}:generateContent?key=${GEMINI_API_KEY}`;
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              if (response.status === 429) {
                const delay = initialDelay * Math.pow(2, attempts);
                await new Promise(res => setTimeout(res, delay));
                attempts++;
                continue;
              }

              if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`TTS API error: ${response.statusText} - ${JSON.stringify(errorBody)}`);
              }

              const result = await response.json();
              const part = result?.candidates?.[0]?.content?.parts?.[0];
              const audioData = part?.inlineData?.data;
              const mimeType = part?.inlineData?.mimeType;

              if (audioData && mimeType && mimeType.startsWith("audio/")) {
                 return `data:${mimeType};base64,${audioData}`;
              } else {
                throw new Error("No audio data found in TTS API response.");
              }
            } catch (error) {
              console.error(`Attempt ${attempts + 1} failed for TTS API:`, error);
              const delay = initialDelay * Math.pow(2, attempts);
              await new Promise(res => setTimeout(res, delay));
              attempts++;
            }
          }
          throw new Error("Max TTS API retry attempts reached.");
        }

        // --- Common UI Components ---
        const MessageModal = ({ message, type, onClose }) => {
          if (!message) return null;

          const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
          const borderColor = type === 'error' ? 'border-red-700' : 'border-green-700';

          return (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className={`relative ${bgColor} text-white p-6 rounded-lg shadow-xl border-2 ${borderColor} max-w-sm w-full animate-fade-in`}>
                <h3 className="text-xl font-bold mb-4">{type === 'error' ? 'Error' : 'Success'}</h3>
                <p className="mb-6">{message}</p>
                <button
                  onClick={onClose}
                  className="w-full bg-white text-gray-800 py-2 px-4 rounded-md hover:bg-gray-100 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-75"
                >
                  Close
                </button>
              </div>
            </div>
          );
        };

        const LoadingSpinner = ({ text = "Loading..." }) => (
          <div className="flex flex-col items-center justify-center p-4">
            <div className="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-accent-vibrant"></div>
            <p className="mt-3 text-primary-dark text-lg">{text}</p>
          </div>
        );

        // --- Navigation Bar ---
        const Navbar = () => {
          const { signOutUser } = useFirebase();
          const tabs = [
            { name: 'News Hub', id: 'news', path: '/news' },
            { name: 'Events', id: 'events', path: '/events' },
            { name: 'Meetups', id: 'meetups', path: '/meetups' },
            { name: 'Community Feed', id: 'community', path: '/community' },
            { name: 'Weekly Debate', id: 'debate', path: '/debate' },
            { name: 'Pedro Poll', id: 'pedroPoll', path: '/poll' },
            { name: 'Legislative', id: 'legislative', path: '/legislative' },
            { name: 'Explore', id: 'explore', path: '/explore' },
            { name: 'Chat', id: 'chat', path: '/chat' },
            { name: 'Reels', id: 'reels', path: '/reels' },
            { name: 'Friends', id: 'friends', path: '/friends' },
          ];

          return (
            <nav className="bg-primary-dark p-4 shadow-lg sticky top-0 z-40">
              <div className="container mx-auto flex flex-wrap justify-between items-center">
                <Link to="/" className="text-3xl font-extrabold text-background-light mr-4 font-montserrat">Nuestro Pulso</Link>
                <div className="flex-grow">
                  <ul className="flex flex-wrap justify-center sm:justify-end gap-x-4 gap-y-2 mt-2 sm:mt-0">
                    {tabs.map((tab) => (
                      <li key={tab.id}>
                        <Link
                          to={tab.path}
                          className="py-2 px-4 rounded-md text-lg font-medium transition-all duration-300 ease-in-out font-poppins text-background-light hover:text-accent-vibrant hover:bg-primary-light"
                        >
                          {tab.name}
                        </Link>
                      </li>
                    ))}
                 <li>
                    <button
                        onClick={signOutUser}
                        className="py-2 px-4 rounded-md text-lg font-medium transition-all duration-300 ease-in-out font-poppins text-background-light hover:text-red-400 hover:bg-primary-light"
                    >
                        Sign Out
                    </button>
                </li>
              </ul>
            </div>
          </div>
        </nav>
      );
    };

    // --- News Hub Component ---
    const NewsHub = () => {
      const [newsArticles, setNewsArticles] = React.useState([]);
      const [loading, setLoading] = React.useState(false);
      const [selectedArticle, setSelectedArticle] = React.useState(null);
      const [message, setMessage] = React.useState('');
      const [messageType, setMessageType] = React.useState('');
      const [showModal, setShowModal] = React.useState(false);
      const [ttsAudioUrl, setTtsAudioUrl] = React.useState(null);
      const [ttsLoading, setTtsLoading] = React.useState(false);
      const [discussionText, setDiscussionText] = React.useState('');
      const [discussionLoading, setDiscussionLoading] = React.useState(false);
      const [discussionResponse, setDiscussionResponse] = React.useState('');
      const [timeFilter, setTimeFilter] = React.useState('24h');
      const audioRef = React.useRef(null);

      const fetchNews = async () => {
        setLoading(true);
        setNewsArticles([]);
        setMessage('');
        setMessageType('');
        try {
          const prompt = `Generate 5 recent, diverse, and realistic news headlines with short summaries (2-3 sentences each) for Colombia, covering politics, economy, social issues, and culture. Ensure variety in topics. Also, provide a placeholder URL for each article. Return as a JSON array of objects with 'title', 'summary', and 'url' keys.`;

          const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: {
              responseMimeType: "application/json",
              responseSchema: {
                type: "ARRAY",
                items: {
                  type: "OBJECT",
                  properties: {
                    "title": { "type": "STRING" },
                    "summary": { "type": "STRING" },
                    "url": { "type": "STRING" }
                  },
                  propertyOrdering: ["title", "summary", "url"]
                }
              }
            }
          };

          const result = await callGeminiAPI(payload);
          if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
            const jsonString = result.candidates[0].content.parts[0].text;
            const parsedNews = JSON.parse(jsonString);

            const newsWithMetadata = parsedNews.map((article, index) => ({
              ...article,
              id: `news-${index}-${Date.now()}`,
              timestamp: Date.now() - (Math.random() * (timeFilter === '24h' ? 86400000 : (timeFilter === '7d' ? 604800000 : (timeFilter === '30d' ? 2592000000 : 0)))),
            }));
            setNewsArticles(newsWithMetadata);
            setMessage("News Refreshed!");
            setMessageType("success");
          } else {
            setMessage("Failed to generate news articles.");
            setMessageType("error");
          }
        } catch (error) {
          console.error("Error fetching/generating news:", error);
          setMessage("Error fetching news: " + error.message);
          setMessageType("error");
        } finally {
          setLoading(false);
          setShowModal(true);
        }
      };

      const handleReadAloud = async (text) => {
        setTtsLoading(true);
        setTtsAudioUrl(null);
        try {
          const audioUrl = await callTtsApi(`Say in a neutral tone: ${text}`);
          setTtsAudioUrl(audioUrl);
          if (audioRef.current) {
            audioRef.current.load();
            audioRef.current.play();
          }
        } catch (error) {
          console.error("Error reading aloud:", error);
          setMessage("Failed to read article aloud.");
          setMessageType("error");
          setShowModal(true);
        } finally {
          setTtsLoading(false);
        }
      };

      const handleDiscussArticle = async () => {
        if (!discussionText.trim()) return;

        setDiscussionLoading(true);
        setDiscussionResponse('');
        try {
          const prompt = `Discuss the following news article: "${selectedArticle.title} - ${selectedArticle.summary}". User comment: "${discussionText}". Provide a concise and insightful response, encouraging further discussion.`;
          const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
          const result = await callGeminiAPI(payload);
          if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
            setDiscussionResponse(result.candidates[0].content.parts[0].text);
          } else {
            setDiscussionResponse("Could not generate a discussion response.");
          }
        } catch (error) {
          console.error("Error discussing article:", error);
          setDiscussionResponse("Error initiating discussion.");
        } finally {
          setDiscussionLoading(false);
          setDiscussionText('');
        }
      };

      React.useEffect(() => {
        fetchNews();
      }, [timeFilter]);

      const filteredNews =
